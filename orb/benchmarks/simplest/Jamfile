# (c) Copyright 2012,2013 Felipe Magno de Almeida
#
# Distributed under the Boost Software License, Version 1.0. (See
# accompanying file LICENSE_1_0.txt or copy at
# http://www.boost.org/LICENSE_1_0.txt)

import testing ;
import feature ;

feature.feature test-orb : morbid mico tao oil : composite link-incompatible ;

path-constant current : . ;
path-constant install : ../../../install ;

project morbid/benchmarks/simplest ;

make simplest.hpp : simplest.idl : @morbid.compileidl : <dependency>/morbid//install-idl <test-orb>morbid ;

exe morbid_client
 : morbid-client.cpp /morbid//morbid /boost//chrono
 : <implicit-dependency>simplest.hpp
   <test-orb>morbid
 ;
exe morbid_server
 : morbid-server.cpp /morbid//morbid /boost//chrono 
 : <implicit-dependency>simplest.hpp
   <test-orb>morbid
 ;

actions morbid.compileidl
{
  $(install:G=)/morbid_idl -i $(>) -o $(<:S=)
}
actions run-client-server
{
  rm -f $(<).ior
  touch $(<).ior

  $(>[2]) $(<).ior > $(<).server &
  server_pid=$!

  while [ `wc -l < $(<).ior` -lt 1 ]
  do
   echo waiting
   kill -s 0 $server_pid

   if [ "$?" -ne 0 ]
   then
     exit 1
   fi

   sleep 1
  done

  $(>[1]) $(<).ior > $(<).client
  if [ "$?" -eq 0 ]
  then
    wait $server_pid
  else
    kill -s KILL $server_pid
    exit 1
  fi
}

alias mico_client : mico//mico_client ;
alias mico_server : mico//mico_server ;
alias tao_client : tao//tao_client ;
alias tao_server : tao//tao_server ;

if [ option.get benchmark-oil : : 1 ]
{
  alias oil_client : oil//client ;
  alias oil_server : oil//server ;
}

make morbid_morbid.output : morbid_client morbid_server : @run-client-server ;
make mico_mico.output : mico_client mico_server : @run-client-server ;
make morbid_mico.output : morbid_client mico_server : @run-client-server ;
make mico_morbid.output : mico_client morbid_server : @run-client-server ;
make tao_tao.output : tao_client tao_server : @run-client-server ;
make morbid_tao.output : morbid_client tao_server : @run-client-server ;
make tao_morbid.output : tao_client morbid_server : @run-client-server ;
make mico_tao.output : tao_client mico_server : @run-client-server ;
make tao_mico.output : mico_client tao_server : @run-client-server ;

if [ option.get benchmark-oil : : 1 ]
{
  make oil_oil.output : oil_client oil_server : @run-client-server ;
  make morbid_oil.output : morbid_client oil_server : @run-client-server ;
  make oil_morbid.output : oil_client morbid_server : @run-client-server ;
  make mico_oil.output : mico_client oil_server : @run-client-server ;
  make oil_mico.output : oil_client mico_server : @run-client-server ;
  make tao_oil.output : tao_client oil_server : @run-client-server ;
  make oil_tao.output : oil_client tao_server : @run-client-server ;
}

if [ option.get benchmark-oil : : 1 ]
{
  alias simplest : morbid_morbid.output mico_mico.output morbid_mico.output mico_morbid.output tao_tao.output tao_morbid.output morbid_tao.output mico_tao.output tao_mico.output
  oil_oil.output mico_oil.output oil_mico.output morbid_oil.output oil_morbid.output tao_oil.output oil_tao.output
 ;
}
else
{
  alias simplest : morbid_morbid.output mico_mico.output morbid_mico.output mico_morbid.output tao_tao.output tao_morbid.output morbid_tao.output mico_tao.output tao_mico.output ;
}

